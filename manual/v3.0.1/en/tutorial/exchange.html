<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimization by replica exchange Monte Carlo &#8212; ODAT-SE 3.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=fce32b03" />
    <script src="../_static/documentation_options.js?v=08bfcbec"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimization by population annealing" href="pamc.html" />
    <link rel="prev" title="Optimization by Bayesian Optimization" href="bayes.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>ODAT-SE 3.0.1 documentation</span></a></h1>
        <h2 class="heading"><span>Optimization by replica exchange Monte Carlo</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="bayes.html">Optimization by Bayesian Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pamc.html">Optimization by population annealing</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="optimization-by-replica-exchange-monte-carlo">
<h1>Optimization by replica exchange Monte Carlo<a class="headerlink" href="#optimization-by-replica-exchange-monte-carlo" title="Link to this heading">¶</a></h1>
<p>This tutorial describes how to estimate the minimization problem of Himmelblau function by using the replica exchange Monte Carlo method (RXMC).</p>
<section id="sample-files">
<h2>Sample files<a class="headerlink" href="#sample-files" title="Link to this heading">¶</a></h2>
<p>Sample files are available from <code class="docutils literal notranslate"><span class="pre">sample/analytical/exchange</span></code> .
This directory includes the following files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">input.toml</span></code></p>
<p>The input file of odatse</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">do.sh</span></code></p>
<p>Script files for running this tutorial</p>
</li>
</ul>
</section>
<section id="input-files">
<h2>Input files<a class="headerlink" href="#input-files" title="Link to this heading">¶</a></h2>
<p>This subsection describes the input file.
For details, see the input file section of the manual.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
<span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>

<span class="p">[</span><span class="n">solver</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;analytical&quot;</span>
<span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;himmelblau&quot;</span>

<span class="p">[</span><span class="n">algorithm</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;exchange&quot;</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">12345</span>

<span class="p">[</span><span class="n">algorithm</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
<span class="n">min_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
<span class="n">max_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">]</span>
<span class="n">step_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>

<span class="p">[</span><span class="n">algorithm</span><span class="o">.</span><span class="n">exchange</span><span class="p">]</span>
<span class="n">Tmin</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">Tmax</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">numsteps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">numsteps_exchange</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nreplica_per_proc</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
<p>In the following, we will briefly describe this input file.
For details, see the manual of <a class="reference internal" href="../algorithm/exchange.html"><span class="doc">Replica exchange Monte Carlo exchange</span></a>.</p>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">[base]</span></code>, <code class="docutils literal notranslate"><span class="pre">[solver]</span></code>, and <code class="docutils literal notranslate"><span class="pre">[runner]</span></code> sections are the same as those for the search by the Nelder-Mead method (<code class="docutils literal notranslate"><span class="pre">minsearch</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">[algorithm]</span></code> section specifies the algorithm to use and its settings.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of the algorithm you want to use. In this tutorial we will use RXMC, so specify <code class="docutils literal notranslate"><span class="pre">exchange</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">seed</span></code> is the seed that a pseudo-random number generator uses.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">[algorithm.param]</span></code> section sets the parameter space to be explored.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_list</span></code> is a lower bound and <code class="docutils literal notranslate"><span class="pre">max_list</span></code> is an upper bound.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unit_list</span></code> is step length in one Monte Carlo update (deviation of Gaussian distribution).</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">[algorithm.exchange]</span></code> section sets the hyper parameters for RXMC.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numstep</span></code> is the number of Monte Carlo steps.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numsteps_exchange</span></code> is the number of steps between temperature exchanges.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tmin</span></code>, <code class="docutils literal notranslate"><span class="pre">Tmax</span></code> are the minimum and the maximum of temperature, respectively.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">Tlogspace</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, the temperature points are distributed uniformly in the logarithmic space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nreplica_per_proc</span></code> specifies the number of replicas that one MPI process handles.</p></li>
</ul>
</section>
<section id="calculation">
<h2>Calculation<a class="headerlink" href="#calculation" title="Link to this heading">¶</a></h2>
<p>First, move to the folder where the sample file is located. (Hereinafter, it is assumed that you are the root directory of ODAT-SE.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd sample/analytical/exchange
</pre></div>
</div>
<p>Then, run the main program. It will take a few secondes on a normal PC.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mpiexec -np 4 python3 ../../../src/odatse_main.py input.toml | tee log.txt
</pre></div>
</div>
<p>Here, the calculation is performed using MPI parallel with 4 processes.
If you are using Open MPI and you request more processes than the number of cores, you need to add the <code class="docutils literal notranslate"><span class="pre">--oversubscribe</span></code> option to the <code class="docutils literal notranslate"><span class="pre">mpiexec</span></code> command.</p>
<p>When executed, a folder for each MPI rank will be created under <code class="docutils literal notranslate"><span class="pre">output</span></code> directory, and a <code class="docutils literal notranslate"><span class="pre">trial.txt</span></code> file containing the parameters evaluated in each Monte Carlo step and the value of the objective function, and a <code class="docutils literal notranslate"><span class="pre">result.txt</span></code> file containing the parameters actually adopted will be created.</p>
<p>These files have the same format: the first two columns are time (step) and the index of walker in the process, the third is the temperature, the fourth column is the value of the objective function, and the fifth and subsequent columns are the parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># step walker T fx x1 x2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.01</span> <span class="mf">170.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="mf">0.01123654800138751</span> <span class="mf">187.94429125133564</span> <span class="mf">5.155393113805774</span> <span class="o">-</span><span class="mf">2.203493345018569</span>
<span class="mi">0</span> <span class="mi">2</span> <span class="mf">0.012626001098748564</span> <span class="mf">3.179380982615041</span> <span class="o">-</span><span class="mf">3.7929742598748666</span> <span class="o">-</span><span class="mf">3.5452766573635235</span>
<span class="mi">0</span> <span class="mi">3</span> <span class="mf">0.014187266741165962</span> <span class="mf">108.25464277273859</span> <span class="mf">0.8127003489802398</span> <span class="mf">1.1465364357510186</span>
<span class="mi">0</span> <span class="mi">4</span> <span class="mf">0.01594159037455999</span> <span class="mf">483.84183395038843</span> <span class="mf">5.57417423682746</span> <span class="mf">1.8381251624588506</span>
<span class="mi">0</span> <span class="mi">5</span> <span class="mf">0.01791284454622004</span> <span class="mf">0.43633134370869153</span> <span class="mf">2.9868796504069426</span> <span class="mf">1.8428384502208246</span>
<span class="mi">0</span> <span class="mi">6</span> <span class="mf">0.020127853758499396</span> <span class="mf">719.7992581349758</span> <span class="mf">2.972577711255287</span> <span class="mf">5.535680832873856</span>
<span class="mi">0</span> <span class="mi">7</span> <span class="mf">0.022616759492228647</span> <span class="mf">452.4691017123836</span> <span class="o">-</span><span class="mf">5.899340424701358</span> <span class="o">-</span><span class="mf">4.722667479627368</span>
<span class="mi">0</span> <span class="mi">8</span> <span class="mf">0.025413430367026365</span> <span class="mf">45.5355817998709</span> <span class="o">-</span><span class="mf">2.4155554347674215</span> <span class="mf">1.8769341969872393</span>
<span class="mi">0</span> <span class="mi">9</span> <span class="mf">0.028555923019901074</span> <span class="mf">330.7972369561986</span> <span class="mf">3.717750630491217</span> <span class="mf">4.466110964691396</span>
<span class="mi">0</span> <span class="mi">10</span> <span class="mf">0.032086999973704504</span> <span class="mf">552.0479484091458</span> <span class="mf">5.575771168463163</span> <span class="mf">2.684224163039442</span>
<span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">best_result.txt</span></code> is filled with information about the parameter with the optimal objective function, the rank from which it was obtained, and the Monte Carlo step.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nprocs</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">rank</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">step</span> <span class="o">=</span> <span class="mi">8025</span>
<span class="n">walker</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">fx</span> <span class="o">=</span> <span class="mf">3.358076734724385e-06</span>
<span class="n">x1</span> <span class="o">=</span> <span class="mf">2.9998063442504126</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mf">1.999754886043102</span>
</pre></div>
</div>
<p>In ODAT-SE, one replica holds samples at different temperatures because of the temperature exchanges. The <code class="docutils literal notranslate"><span class="pre">result.txt</span></code> in each rank folder records the data sampled by each replica.
The data reorganized for each temperature point is written to <code class="docutils literal notranslate"><span class="pre">output/result_T%.txt</span></code>, where <code class="docutils literal notranslate"><span class="pre">%</span></code> is the index of the temperature point.
The first column is the step, the second column is the rank, the third column is the value of the objective function, and the fourth and subsequent columns are the parameters.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># T = 0.014187266741165962</span>
<span class="mi">0</span> <span class="mi">3</span> <span class="mf">108.25464277273859</span> <span class="mf">0.8127003489802398</span> <span class="mf">1.1465364357510186</span>
<span class="mi">1</span> <span class="mi">3</span> <span class="mf">108.25464277273859</span> <span class="mf">0.8127003489802398</span> <span class="mf">1.1465364357510186</span>
<span class="mi">2</span> <span class="mi">3</span> <span class="mf">108.25464277273859</span> <span class="mf">0.8127003489802398</span> <span class="mf">1.1465364357510186</span>
<span class="mi">3</span> <span class="mi">3</span> <span class="mf">108.25464277273859</span> <span class="mf">0.8127003489802398</span> <span class="mf">1.1465364357510186</span>
<span class="mi">4</span> <span class="mi">3</span> <span class="mf">93.5034551820852</span> <span class="mf">1.3377081691728905</span> <span class="mf">0.8736706475438123</span>
<span class="mi">5</span> <span class="mi">3</span> <span class="mf">81.40963740872147</span> <span class="mf">1.4541906604820898</span> <span class="mf">1.0420053981467825</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Link to this heading">¶</a></h2>
<p>By plotting <code class="docutils literal notranslate"><span class="pre">output/result_T%.txt</span></code>, you can estimate regions where the parameters with small function values are located.
By executing the following command, the figures of two-dimensional plot <code class="docutils literal notranslate"><span class="pre">res_T%.png</span></code> will be generated.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 ../plot_himmel.py --xcol=3 --ycol=4 --skip=20 --format=&quot;o&quot; --output=output/res_T0.png output/result_T0.txt
</pre></div>
</div>
<p>Looking at the resulting diagram, we can see that the samples are concentrated near the minima of <code class="docutils literal notranslate"><span class="pre">f(x)</span></code>. By changing the index of the temperature, the sampling points scatters over the region at high temperature, while they tend to concentrate on the minima at low temperature.</p>
<figure class="align-default" id="id1">
<img alt="../_images/res_exchange.png" src="../_images/res_exchange.png" />
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Distribution of sampling points on two-dimensional parameter space at <span class="math notranslate nohighlight">\(T=\{35.02, 3.40, 0.33, 0.01\}\)</span>.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="bayes.html">Optimization by Bayesian Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pamc.html">Optimization by population annealing</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2020, Institute for Solid State Physics, University of Tokyo.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.0.
    </div>
  </body>
</html>